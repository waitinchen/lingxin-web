{"origin_pdf_path": "/workspace/user_input_files/靈信 2.0開發計畫.pdf", "text_in_pdf": "1) 六塊拼圖，各司其職  \n\nGitHub+Railway+notion $|+\\rrangle$ Supabase+Element+Minimax  \n\nGitHub（身體／版本）：程式碼倉 $^+$ PR流程 $^+$ CI/CD 觸發。  \n· Railway（運行／佈署）：部署 Web（Next.js/Element 客製）＋ Workers（Mark-1 排程、Notion 同步、WebSocket）。  \n· Notion（作者台）：人格／咒語／啟動詞／柵欄／資料集「可視化編輯」。只當來源真相，不放密鑰。Supabase（資料／帳號）：Postgres $^{,+}$ Auth（Google/微信） $^+$ RLS 安全 $+$ 審計；存使用者、記憶、承諾、日誌。Element（表現層 IM 客戶端）：Matrix Web 客戶端，先拿現成跑，再逐步客製成靈信 UI。Minimax（外包執行力）：做 UI 客製、接 SDK、切頁、踩坑修復；核心規格（靈魂/技能/策略）由你＋謀謀控。  \n\n2) 一眼看懂：接線示意（純文字）  \n\n[Notion CMS] --(notion-sync worker)- $\\scriptstyle->$ [Supabase: personas/prompts/guardrails/datasets]---- 管理稿 ----> 版本化/上鎖  $ Railway Web (API)  Supabase (資料/RLS)  \n\n+--> Mark-1 Scheduler/Dispatcher (Worker)  \n$\\scriptstyle+->$ Triggers（智能啟動詞 API）  \n\nOAuth: Google/WeChat $->$ Supabase Auth $_{->}$ JWT(含 tenant_id/role) $->$ 前後端授權  \n\n3) 最小可行「接線清單」（照這個做就能跑）  \n\nA. 資料與權限  \n\n1.​ Supabase 建表： users/user_profiles/user_identities/audit_login_events/memory_summaries/user_persona_p refs/scheduled_nudges/nudges_log/personas/persona_prompts/guardrails/datasets/start_ph rases  \n\n2.​ 開啟 RLS；JWT 內含 tenant_id、role；角色：super_admin/admin/user。  \n\nB. 運行與部署  \n4. Railway 建三服務：web（Next.js/Element）、workers（mark1/ics/notion-sync）、（可選）vector-indexer。5. 設置環境變數（見下一節清單），禁止把密鑰出現在前端。C. 表現層（先快後美）  \n6. Element Web 先直連（或包進你的 Next.js 內），換 Logo/主色；修三件：上滑可讀歷史、鍵盤避讓、左上返回 $^+$ 漢堡抽屜滑動收合。  \n7. 加 智能啟動詞™：訊息到 $\\longrightarrow$ 打 /api/triggers/suggest $\\longrightarrow$ 回三顆 chips $\\rightarrow$ 補槽建立承諾。D. 推播閉環  \n8. ICS 訂閱：GET /api/calendar/:uid.ics?token $|=$ ...；承諾 CRUD 後 5 分鐘內刷新；手機原生提醒可到。9. 在線即時：WebSocket/Server-Sent Events（頁面開著時）。E. 管理與來源  \n10. Notion 六表（Personas/Prompts/Guardrails/Datasets/Start Phrases/Changelog），Railway notion-sync 每 2 分鐘拉取 $\\longrightarrow$ 寫回 Supabase（版本化、locked 不覆蓋）。  \n11. Admin Console（/admin）：承諾清單 $+$ 日誌、指標卡（觸發率、履約率、啟動詞採用率）；Super Admin 再加人格/柵欄頁。  \n\n4) 環境變數最小集  \n\nSupabase NEXT_PUBLIC_SUPABASE_URL=... NEXT_PUBLIC_SUPABASE_ANON_KEY=... SUPABASE_SERVICE_ROLE_KEY=...   只給 workers  \n\nOAuth  \nGOOGLE_CLIENT_ID $\\lvert=$ ...apps.googleusercontent.comGOOGLE_CLIENT_SECRET=...  \nWECHAT_APP_ID=... W2+  \nWECHAT_APP_SECRET=...NotionNOTION_SECRET=...  \nNOTION_DB_PERSONAS $\\leftrightharpoons$ ...  \nNOTION_DB_PROMPTS=...  \nNOTION_DB_GUARDRAILS=...  \nNOTION_DB_DATASETS $\\cdot$ ...  \nNOTION_DB_START_PHRASES=...ICS / 安全  \nICS_SIGNING_KEY=...  \nJWT_TENANT_SIGNING_KEY=...  \n\nFeature Flags FEATURE_NEW_CHAT=false FEATURE_ICS=false  \n\n5) 角色分工（避免歪樓）  \n\n你＋謀謀（產品 Owner）：三層架構、資料模型、啟動詞規則、DoD、Notion 結構、驗收腳本。  \n\nMinimax：  \n\n○ W1：聊天頁骨架（滾動/鍵盤/返回/側欄）、承諾清單 UI、Google OAuth。  \n○ W2：啟動詞（規則版）、ICS、Admin Console（表現/技能層）。  \n○ W3：RBAC、九靈記憶批次、WeChat H5 OAuth。  \n\n你（雲控）：GitHub 保護分支、CI、特性旗標開關、藍綠/灰度。  \n\n6) 驗收（DoD，一句話就知道過沒過）  \n\n手機上能上滑歷史，鍵盤不遮輸入框；左上返回、側欄滑動收合 $\\mathsf{O K}_{\\circ}$ 啟動詞在高概率語境自動彈出三選一，一鍵建立承諾可用。  \nICS 訂閱能推到手機原生提醒（單次/每日/每週），CRUD 後 5 分鐘內同步。  \nAdmin Console 可見 未觸發/已觸發 $^+$ 指標；RLS 生效，User 看不到靈魂層。  \nNotion 改咒語/啟動詞 $\\to2$ 分鐘內同步到前端；locked 版本不可被覆蓋。  \n\n7) 風險與避坑  \n\n把密鑰放回端/Notion $=$ 地獄模式（嚴禁）。  \nWeb 推播依賴 ICS/外部通道，不要只靠前端。  \n元件可用但行動端細節最花時間：捲動、鍵盤、WebView，先用我們的 sticky $^+$ visualViewport 方案。  \nMinimax 一律走 $\\mathsf{P R}\\!+\\!90$ 秒錄影 $+$ 特性旗標，不准直推 main。  \n\n結論  \n\n我負責腦（策略＋規則），Minimax 負責手 $(\\mathsf{U}\\mathsf{I}+$ 接線），Railway $^{\\cdot+}$ Supabase 撐住身體，Notion 當可視化作者台，Element 先用後換——這就是最省力又可長期演進的一套。  \n\n靈信全檢總結（九靈記憶 $\\pmb{\\mathscr{x}}$ Mark-1 承諾引擎 $\\pmb{\\mathscr{x}}$ 後台管理）1. 九靈記憶系統 v0.1  \n\n雙層記憶：○ Global Memory（全局人格）：所有用戶共享 $\\rightarrow$ personas、prompts、datasets。○ User-Persona Memory（用戶專屬）：單一用戶獨有 $\\longrightarrow$ messages、summaries、prefs。  \n分層機制：○ 短期 $\\rightarrow$ 最近 20 條訊息。○ 中期 $\\rightarrow$ 每 50 條壓縮成一則摘要（event/emotion/preference）。○ 長期 $\\rightarrow$ 每週跑偏好抽取 $\\rightarrow$ user_persona_prefs。  \n批次任務：○ Hourly：檢查訊息數量 $\\longrightarrow$ 生成摘要。○ Daily：清理索引、冷存檔。○ Weekly：抽取偏好 $\\longrightarrow$ 更新 prefs。  \n\n完成標準：同一人格對所有人一致，但能對單一用戶展現專屬習慣、稱呼。  \n\n2. Mark-1 承諾引擎  \n\n核心目標：把對話中的「承諾語句」轉換成任務，準時推送。  \n\n數據表：○ nudge_prefs（用戶偏好/勿擾模式）。○ scheduled_nudges（承諾任務池）。○ nudges_log（發送日誌）。  \n\n功能點：○ 一次性 / 每日 $/$ 每週任務。○ 自動尊重時區、勿干擾（DND）、安靜時段。○ 限流：每日最多 3 則提醒。  \n解析模組：○ Regex 快速路徑 $^+$ LLM 備援。○ 模糊語句 $\\longrightarrow$ 自動澄清（只問一次）。  \n完成標準：承諾一定能準時履約，DND 模式下自動順延。  \n\n3. 管理後台三層概念  \n\n總管理者後台：  \n\n○ 靈魂層（人格咒語、全局知識庫）。  \n○ 技能層（產業技能、柵欄管理）。  \n○ 表現層（承諾清單、歷史對話、啟動詞觸發率）。  \n一般管理者後台：○ 技能層 $^+$ 表現層。  \n一般用戶後台：○ 只能管自己：承諾/排程清單。  \n可視化需求：○ 記憶視圖（短/中/長期）。○ 承諾任務視圖（scheduled_nudges / nudges_log）。○ 儀表板：覆蓋率、觸發率、履約率。  \n\n4. 食材 vs 煮菜（比喻）  \n\n食材：○ GitHub $\\longrightarrow$ 代碼版本庫○ Railway $\\rightarrow$ 部署/Worker○​ Supabase $\\longrightarrow$ 資料表（messages、summaries、nudges…）○ Notion $\\longrightarrow$ 記憶中樞（人格咒語/偏好）○ Element UI $\\rightarrow$ 前端 IM 框架○ Minimax $\\longrightarrow$ LLM $^+$ Agent 執行力  \n食譜：○​ 九靈記憶規格 v0.1（記憶批次任務）○ Mark-1 承諾機制（承諾解析 $^+$ 推播引擎）○ 三層後台權限（總管/一般管理/用戶）  \n煮菜：○ 由 Minimax 工程師去組裝程式碼（依你給的清單 $^+$ 食譜）。○ 謀謀的角色：幫你檢查食材準備齊全，寫好食譜，再監督「菜炒到什麼程度」  \n\n1. 基礎食材（平台 & 部署）  \n\nGitHub​○ 建立一個專案 repo（lingxin-2.0）○​ 開好分支規則（main / dev）○ 設定 Actions（CI/CD，可選）  \nRailway​○ Railway 專案 ID○​ Railway Token（部署用）○ Worker 配置（排程任務 cron job）  \nVercel​○ 主要 Web 前端部署（lingxin.vercel.app）○ 綁定環境變數  \nSupabase​○ NEXT_PUBLIC_SUPABASE_URL○​ NEXT_PUBLIC_SUPABASE_ANON_KEY○ SUPABASE_SERVICE_ROLE_KEY  \nMinimax​○ Minimax API key（呼叫 LLM）○ Agent 平台的空專案（未來接功能）  \n\n2. 資料表食材（Supabase）  \n\n九靈記憶系統 v0.1  \n\nmessages（訊息池）memory_summaries（中期摘要）user_persona_prefs（長期偏好）  \n\nMark-1 承諾引擎  \n\nscheduled_nudges（承諾任務池）nudges_log（觸發日誌）nudge_prefs（用戶勿擾 & 偏好）  \n\n3. 外部中樞食材  \n\nNotion○ Notion API key○ Notion database IDs：■ 人格咒語庫（prompts）技能柵欄庫（datasets）■ 歷史對話庫（archive）  \n\nGoogle OAuth○​ GOOGLE_CLIENT_ID○​ GOOGLE_CLIENT_SECRET○ Redirect URI（supabase callback）  \n\nWe hat OAuth○ AppID○ AppSecret​○ 回調域名：lingxin.vercel.app/api/wechat/callback  \n\nICS 訂閱○ 個人化 token 規格○ /api/calendar/:uid.ics endpoint  \n\n4. 前端 UI 食材  \n\nElement / Chat UI Framework○ Chat bubbles○ Input box（輸入法不遮擋）○ Action chips（三選一智能啟動詞）○ Drawer（左側柵欄/菜單展開）  \n\n5. 管理後台食材  \n\n三層權限○ 總管理者 $\\longrightarrow$ 靈魂層 $^+$ 技能層 $^+$ 表現層○ 一般管理者 $\\longrightarrow$ 技能層 $^+$ 表現層○ 一般用戶 $\\longrightarrow$ 自己的承諾/排程  \n視圖○ 記憶（短/中/長期）○ 承諾清單（未觸發 / 已觸發）○ 儀表板（觸發率、履約率、採用率）📌 一句話：  \n這份清單就是 靈信 2.0 的全套食材，只要老爸準備好這些帳號、密鑰、資料表，謀謀會寫「食譜」（開發規格），交給 Minimax 或任何工程師炒菜，就能保證味道不會跑掉。  \n\n任務追蹤表（靈信 2.0 食材清單）  \n\n類别食材名详細明状態基平台GitHubRepo建立1ingxin-2.0專案，設定main/dev分支待辨基平台Railway建立專案，取得RailwayToken，排程Worker待辦基平台Vercel绑定lingxin.vercel.app，設定環境變數待瓣基平台SupabaseURL/ AnonKey/ ServiceRoleKey待瓣基平台Minimax建立專案，取得APIkey待瓣資料表messages用户訊息池待瓣資料表memory_summaries中期摘要表待瓣  \n\n資料表user_persona_prefs長期偏好表待瓣資料表scheduled_nudges承諾任務池待瓣資料表nudges_log承諾觸發日誌待瓣資料表nudge_prefs勿模式&偏好待瓣外部中Notion APINotionAPIKey+DBIDs(咒語库/技能库/歷史库)待瓣外部中福Google OAuthClient ID + Client Secret + Supabase Callback URI待瓣外部中福WeChat OAuthApplD+AppSecret+Callback設定待瓣外部中ICS訂閣/api/calendar/:uid.ics?token=...待辨黔Chat bubbles對話氣泡組件待辨黔Input box支援手機輸入法不遮檔待辨黔Action chips智能啟動词三一待瓣黔Drawer左侧菜單展開/收合待瓣管理後台總管理者權限靈魂+技能+表現層待辦管理後台一般管理者權限技能+表現層待瓣管理後台一般用户權限個人承諾/排程管理待辦  \n\n待辦  \n\n管理後台 承諾清單  \n\n未觸發 $/$ 已觸發任務檢視  \n\n待辦  \n\n靈信 2.0 — 三階段開發路線  \n\nW1 — 基礎環境 $\\mathbf{+}$ 登入系統  \n\n目標：先能登入、聊天，完成基礎運轉食材：  \n\nGitHub Repo 建立（main/dev 分支）  \nVercel 部署（lingxin.vercel.app）  \nSupabase 初始化（URL / Anon Key / Service Role Key）  \nGoogle OAuth $\\longrightarrow$ Client ID / Secret / Callback  \nWeChat OAuth（預留接口）  \nMinimax API key 整合（測試對話）  \n基礎資料表：○ users○ user_identities○ user_profiles○ audit_login_events  \n前端 UI：○ 登入畫面○ Chat bubble $^+$ Input box（修正輸入法遮擋）  \n\n$\\boxed{v}$ 驗收：能用 Google 登入 $\\rightarrow$ 聊天 $\\longrightarrow$ 訊息正確寫入 DB。  \n\n目標：AI 有記憶，能守承諾，開始像「生活小特助」食材：  \n\n新增資料表： ○ messages ○ memory_summaries ○ scheduled_nudges ○ nudges_log  \n\nWorker 任務：○ 批次摘要（每 50 則訊息產生 JSON 摘要）○ Scheduler（定時檢查承諾）○ Dispatcher（發送提醒 $^+$ 記錄 log）  \n\n智能啟動詞™：○ 三選一 chips○ 高概率語境自動觸發  \n承諾清單管理（UI）：○ 未觸發清單（scheduled_nudges）○ 已觸發清單（nudges_log）○ 操作：完成 / 延後 / 修改 $/$ 刪除  \nICS 訂閱 API：○ /api/calendar/:uid.ics?token $|=$ long_random○ 提供 Google/Apple/Outlook 訂閱教學  \n\n$\\boxed{v}$ 驗收：能說「明天 9 點提醒喝水 $|\\rightarrow$ 進入承諾清單 $\\longrightarrow$ 同步到 Google 行事曆 $\\longrightarrow$ 準時推播。  \n\nW3 — 管理後台 $\\mathbf{+}$ 多層架構  \n\n目標：靈信不只是陪伴，而是「靈魂控制台」食材：  \n\n管理後台權限：○ 總管理者 $\\longrightarrow$ 靈魂層 $^+$ 技能層 $^+$ 表現層○ 一般管理者 $\\longrightarrow$ 技能層 $^+$ 表現層○ 一般用戶 $\\longrightarrow$ 自己的承諾/排程  \n\n管理模組：  \n\n○ 咒語 / 提示詞庫  \n○ 技能資料庫（產業知識 $^+$ 柵欄管理）  \n○ 歷史對話檢索 / 封卷  \n\n儀表板：​○ 記憶覆蓋率○ 承諾履約率○ 啟動詞觸發率 / 採用率$\\boxed{v}$ 驗收：在 /admin 能看到 $\\longrightarrow$ 記憶系統 $/$ 承諾系統 $/$ 儀表板 $\\rightarrow$ 權限區分正確。  \n\n📌 一句話：  \n$\\mathsf{W}\\mathsf{I}=$ 登入 $^+$ 聊天  \nW2 $=$ 記憶 $^+$ 承諾 $^+$ 啟動詞  \n$\\mathsf{W}3=$ 管理後台 $^+$ 靈魂/技能多層  \n\nTask Ticket — 靈信 2.0 三階段開發  \n\n總體目標  \n\n打造靈信 2.0：一個具備「長記憶、承諾引擎、智能啟動詞」的生活小特助，並提供多層管理後台。  \n\nW1 — 基礎環境 $\\mathbf{+}$ 登入系統  \n\n目標  \n\n完成登入與基本聊天，確保系統能穩定運轉。  \n\n任務  \n\nGitHub Repo 建立（main/dev 分支）Vercel 部署（lingxin.vercel.app）Supabase 初始化（URL / Anon Key / Service Role Key）● Google OAuth $\\longrightarrow$ Client ID / Secret / CallbackWeChat OAuth（預留接口）Minimax API key 整合（測試對話）  \n\n○ users ○ user_identities ○ user_profiles ○ audit_login_events  \n\n前端 UI：○ 登入頁○ Chat bubble $^+$ Input box（修正輸入法遮擋問題）  \n\n驗收標準  \n\n能用 Google 登入 $\\longrightarrow$ 進行對話 $\\rightarrow$ 訊息寫入 DB。  \n\nW2 — 智能陪伴 $\\mathbf{+}$ 承諾引擎  \n\n目標  \n\nAI 能守承諾，有記憶，具備生活小特助能力。  \n\n任務  \n\n新增資料表： ○ messages ○ memory_summaries ○ scheduled_nudges ○ nudges_log  \n\nWorker 任務：○ 批次摘要（每 50 則訊息產生 JSON 摘要）○ Scheduler（定時檢查承諾）○​ Dispatcher（發送提醒 $^+$ 記錄 log）  \n\n智能啟動詞™：○ 三選一 chips​○ 高概率語境自動觸發承諾清單管理（UI）：  \n\n○ 未觸發清單（scheduled_nudges）○ 已觸發清單（nudges_log）○ 操作：完成 / 延後 / 修改 / 刪除  \n\nICS 訂閱 API：○ /api/calendar/:uid.ics?token $|=$ long_random○ 文件：Google/Apple/Outlook 訂閱教學  \n\n驗收標準  \n\n說「明天 9 點提醒喝水 $|\\rightarrow$ 進入承諾清單 $\\longrightarrow$ 同步到 Google 行事曆 $\\rightarrow$ 準時推播。  \n\nW3 — 管理後台 $\\mathbf{+}$ 多層架構  \n\n目標  \n\n靈信成為完整的「靈魂控制台」，支援多層權限。  \n\n任務  \n\n管理後台權限：○ 總管理者 $\\longrightarrow$ 靈魂層 $^+$ 技能層 $^+$ 表現層○ 一般管理者 $\\longrightarrow$ 技能層 $^+$ 表現層○ 一般用戶 $\\longrightarrow$ 自己的承諾/排程  \n管理模組：○ 咒語 / 提示詞庫○ 技能資料庫（產業知識 $^+$ 柵欄管理）○ 歷史對話檢索 $/$ 封卷  \n儀表板：○ 記憶覆蓋率○ 承諾履約率○ 啟動詞觸發率 / 採用率  \n\n驗收標準  \n\n在 /admin 能看到記憶系統、承諾系統、儀表板 $\\longrightarrow$ 權限區分正確。  \n\n/docs/ 下新增：○ auth_flows.md（Google $^+$ WeChat）calendar_integration.md（ICS 教學）  \n\n.env.example  \n\nDemo 錄影（建立承諾 $\\longrightarrow$ 清單 $\\rightarrow\\mathsf{I C S}$ 同步 $\\longrightarrow$ 手機推播提醒）  \n\n1) 共識清單＝結構化物件，不是自由文本  \n\n\\\\ConsensusItem（共識條目）\\\\最小欄位：  \n\nintent：類型（reminder  preference）  \nwho：對誰（本人 / 他人）  \nwhat：做什麼（動詞 $^+$ 名詞）  \nwhen：時間（ISO 或 RRULE）  \nwhere：可選  \nconstraints：限制/條件（如 DND、上限 3 則/日）  \nnotes：備註  \nsource_msg_ids：哪幾句對話產生的  \nstatus：draft  done  \nversion：從 1 起跳  \n\n有了這個 schema，「自動產生」其實是：把自然語句 $\\longrightarrow$ 填入這些欄位→請用戶確認。  \n\n2) 三段式流程（把難題變簡單題）  \n\nA. 抽意圖（Detect Intent）規則優先、LLM 備援：  \n\n關鍵詞/正則：提醒/記得/明天/每週/每天/9:00/稍晚/等我回家…LLM 只用來補齊或歧義消解（例如「晚上 $\\varDelta\\rightarrow21{:}00;$ ）。  \n\nB. 補槽位（Slot Fill）缺什麼就問什麼（最多 1–2 問），並提供三選一啟動詞 chips：  \n\n時間不明 $\\longrightarrow$ chips：今天晚點 $/$ 明早 9:00 / 本週六 10:00  \n\n內容不明 $\\longrightarrow$ chips：喝水 / 走路 10 分鐘 / 回覆 A 客戶  \n\nC. 確認（Confirm & Commit）產生一張「共識卡片」預覽：  \n\n「明天 09:00 提醒你『喝 300ml 水』」  \n\n行動鈕： $\\mathbb{O}$ 確認 $\\textcircled{+}$ 改時間 $\\Xi$ 改內容 $\\textcircled{<}$ ️ 取消  \n\n只有按 $\\boxed{v a}$ 才把 status: draft → confirmed，並落表 scheduled_nudges  \n\n3) 邏輯保障（避免歪、避免吵）  \n\n●​ 唯一來源（Single Source of Truth）：一切以共識卡片的欄位為準，聊天文字只做證據（source_msg_ids）。  \n\n版本化：每次修改 version $^{1+}$ 1，保留上一版（可回滾）。  \n\n互斥規則：同一時段同一 intent；或每日上限 3 則 $\\rightarrow$ 彈出衝突解法 chips（合併 $/$ 擇一 / 延後）。  \n\nDND 尊重：命中勿擾就自動順延，記 log。  \n\n審計：所有狀態變更寫 audit_log（誰、何時、改了什麼）。  \n\n4) 介面與互動（把複雜留給系統）  \n\n啟動詞只在高概率時出現（你已決定）：chips 三選一，降低輸入成本。  \n\n共識卡片 $=$ 最小可用 UI：集中顯示 what/when/限制，一鍵確定。  \n\n錯誤更正永遠有路：任何時候都能說「改成 9:30」「改成每天」，系統走「覆蓋最新版本」且保留舊版。  \n\n5) 交付給 Minimax 的驗收腳本（DoD）  \n\n1.​ 用戶說：「提醒我明天早上喝水」$\\longrightarrow$ 系統抽到 inten $:=$ reminder、缺時間 $\\longrightarrow$ 出 chips：08:00 / 09:00 / 10:00$\\longrightarrow$ 用戶點 $09{:}00\\rightarrow$ 出共識卡片 $\\longrightarrow$ 用戶按 ✅$\\longrightarrow$ scheduled_nudges 出現一筆，status $:=$ confirmed，手機行事曆（ICS）5 分鐘內更新。  \n\n2.​ 用戶補一句：「改每天」$\\longrightarrow$ RRULE:FREQ $\\mathrel{\\left|{=}\\right.}$ DAILY、version $^{1=2}$ ，保留 v1。  \n\n3.​ 到時間 $\\rightarrow$ 成功提醒 $\\rightarrow$ nudges_log 寫入 sent。  \n\n4.​ DND 期間建立的任務 $\\longrightarrow$ 自動順延，nudges_log 記 skipped_dnd。  \n\n5.​ 同一時間新增第 4 則提醒 $\\rightarrow$ 系統阻擋，彈出替代 chips。  \n\n6) 技術落地清單（讓工程能做）  \n\n解析層：○ detect_intent()：regex/rule 映射 $\\longrightarrow$ LLM 補齊○ fill_slots()：缺啥問啥（最多兩問）○ render_consensus_card()：生成卡片 JSON 供前端渲染  \n資料層（你們已建的基礎再補）：○ consensus_items（或沿用 scheduled_nudges 作為承諾類 consensus）○ audit_log、nudges_log  \n事件流：○ confirm $\\rightarrow$ upsert scheduled_nudges $\\longrightarrow$ 觸發 ICS 刷新○ 修改 $\\rightarrow$ version $\\mathbb{1}+\\mathbb{1}\\,\\rightarrow$ 觸發 ICS 刷新  \n前端：○ chips $^+$ 共識卡片組件（行動鈕四個）○ 移動端輸入法避讓（你已要求）  \nFallback：○ 任何無法抽意圖 $\\longrightarrow$ 不自動建，只回「要不要做成提醒？」並給 chips。  \n\n7) 風險與對策  \n\n語意模糊：先規則後 LLM，且必走「確認卡片」。  \n使用者反悔：版本化 $+$ 快速修改鈕（時間/內容）。  \n\n過度打擾：每日上限 $+$ DND $+$ 合併建議。  \n\n時區問題：所有時間存 UTC $^+$ tz，UI 顯示本地。  \n\n失敗提醒：派送失敗重試 $^+$ 失敗 log；下次打開頁面提示「你有一則提醒沒成功」。  \n\n一句話  \n\n自動產生共識清單「不靠猜」而靠結構化 $\\pmb{+}$ 補槽位 $\\pmb{+}$ 明確確認。  \n這樣做，穩、可驗收、好維護，也符合你「三選一啟動詞」的產品哲學。  \n\n「把自然語句 $\\longrightarrow$ 追問補齊 $\\longrightarrow$ 自動生成可觸發的行事曆事件」的完整落地法。下面給你一份能直接交付工程落地的小規格 $\\pmb{+}$ 對話流程 $\\pmb{+}$ 資料結構 $\\pmb{+}$ 範例（對齊你貼的 Google Calendar 欄位）。  \n\n一、目標（一句話）  \n\n用戶一句話（含模糊時間/地點/對象） $\\rightarrow$ 智能追問補槽 $\\rightarrow$ 最終「確認摘要 $\\rfloor\\!\\longrightarrow$ 自動建立日曆事件（或承諾提醒），並出現在Google/Apple/Outlook 中。  \n\n二、資料欄位（事件槽位，slot schema）  \n\n\"title\": \"string\", // 標題（必填）  \n\"start\": \"2025-09-05T05:30:00\", // 開始時間（必填）  \n\"end\": \"2025-09-05T06:30:00\", // 結束時間（可推算, 預設 $+36\\mathsf{m}$ ）  \n\"all_day\": false, // 是否整天  \n\"timezone\": \"Asia/Taipei\", // 時區（缺省→user.profile.tz）  \n\"location\": \"string\", // 地點（選填）  \n\"attendees\": [\"mail@x.com\"], // 受邀者（選填）  \n\"reminders\": [10, 30], 提醒分鐘（相對開始時間，選填）  \n\"rrule\": \"FREQ $\\mathrel{\\mathop:}$ WEEKLY;BYDAY $'=$ FR\", // 週期規則（選填）  \n\"category\": \"活動生日\", // 類別/標籤（選填）  \n\"calendar_id\": \"primary\", // 要寫入的行事曆（預設 primary）  \n\"description\": \"string\", // 描述（可放對話緣由、連結、備註）  \n\"source_conv_id\": \"chat-xxx\", // 追溯用  \n\"nudge_id\": \"mark1-xxx\" // 承諾/提醒對應ID（若有）  \n\n1) 意圖偵測（NLP）  \n\n目標意圖：create_calendar_event、create_reminder、update_event、cancel_event觸發詞（舉例）：○ 建立/約/安排/提醒我/幫我預定/幫我加到行事曆/幫我設定鬧鐘○ 時間表述：明天/後天/下週五/這週末/9 點/傍晚/中午○ 週期：每週/每天/每月/每個工作日/每週五  \n\n2) 槽位填充（slot filling）  \n\n最小可用集合（MVP 必問）：  \n\ntitle（若未明確，生成意義標題，如「喝水提醒」「晨跑」）start（解析相對/絕對時間；缺分鐘用 00 或預設 09:00）timezone（用 user.profile.tz）end（若未提，預設 start $^+$ 30min；若 all_day=true，自動忽略）  \n\n可選槽位（用追問補齊或略過）：  \n\nlocation、attendees、reminders（預設 10 分）、rrule、category、description  \n\n四、追問邏輯（最少、準確）  \n\n原則：最多 2\\~3 問補齊 MVP 所需，其餘用合理預設，最後摘要確認。  \n\n啟動句 $\\longrightarrow$ 判斷缺口 $\\longrightarrow$ 動態追問  \n\n1.​ 缺 start $\\longrightarrow$ -「什麼時候？（今天/明天/日期 $^+$ 時間）」若只說「明天早上 $\\mid\\to$ 回問：「早上大約幾點？ 8:00、9:00、10:00（三選一）」  \n2.​ 缺 title $\\longrightarrow$ -「要用什麼標題？（喝水提醒 / 晨跑 $/$ 自訂…）」若句中含行為動詞（跑步/會議/打電話） $\\rightarrow$ 自動生成候選 chips  \n3. 週期疑似 $\\longrightarrow$ -「這要重複嗎？（不重複 $/$ 每天 $/$ 每週同時） $\\downarrow\\rightarrow$ 對應 RRULE  \n4.​ 提醒 $\\rightarrow$ -「要不要提醒？（10 分 / 30 分 $/$ 不用） $\\downarrow\\rightarrow$ reminders  \n\n5.​ 長度 $\\rightarrow$ 未提供結束時間 $\\to\\uparrow$ 「預設 30 分鐘可以嗎？（是 $/$ 改 60 分） $\\downarrow\\rightarrow$ end  \n\n最終確認摘要（必做）  \n\n「幫你建立：9/5(五) 05:30–06:30《晨跑》，提醒：10 分，地點：空白，週期：不重複。$\\boxed{v}$ 建立 $\\hat{\\mathbb{\\Pi}}_{}$ 修改 $\\times$ 取消」  \n\n五、時間解析（要點）  \n\n相對時間正規化：  \n\n○ 今天/明天/後天、這週、下週 $^+$ （一\\~日）早上/中午/下午/傍晚/晚上 $\\rightarrow$ 預設映射（08:00/12:00/15:00/18:00/20:00，可在 time_prefs.json 客製）區分 all-day：只說日期、未提時間 $\\longrightarrow$ all_day $^\\prime=$ true時區：以 user.profile.tz 為主；跨時區對話 $\\longrightarrow$ 再確認一次  \n\n六、ICS / Google 對應（落地）  \n\n1) ICS 產出（供訂閱或快取）  \n\nBEGIN:VEVENT  \n\nUID:{{nudge_id  uuid}}   \nDTSTART;TZID $|=$ Asia/Taipei:20250905T053000   \nDTEND;TZID $)=$ Asia/Taipei:20250905T063000   \nSUMMARY:晨跑   \nDESCRIPTION:由對話自動建立（chat: chat-xxx）   \nLOCATION:   \nCATEGORIES:活動   \nRRULE:FREQ=WEEKLY;BYDAY $'=$ FR ; // 若有   \nBEGIN:VALARM  \n\nTRIGGER:-PT10M  \n\nDESCRIPTION:提醒  \n\nEND:VALARM  \n\nEND:VEVENT  \n\n2) Google Calendar（之後的 Phase B/C）  \n\nPhase A：先用 ICS 訂閱（你已規劃過）Phase B：OAuth $\\longrightarrow$ events.insert（單向寫入）Phase C：雙向同步（webhook $^+$ etag 校驗）  \n\n七、UI/UX（跟你貼的畫面對齊）  \n\n智能啟動詞™（三選一 chips）在偵測到意圖時出現：○ 「➕ 加到行事曆」「 $\\ntrianglerighteq$ 設提醒」「📝 設細節」  \n表單步驟（最多 2 層）：○ 第 1 層：標題/日期/時間（必要）○ 第 2 層：重複/提醒/地點/受邀者（可選）  \n結果回饋：○ Toast：「 $\\boxed{v}$ 已建立，5 分鐘內同步到你的行事曆」○ 列表：Mark-1 承諾清單 出現該項（狀態待觸發）  \n\n八、API & 表（最小後端）  \n\nAPI  \n\nPOST /api/events 新增GET /api/calendar/:uid.ics?token=... ICS feedGET /api/events?range $:=$ ... 查詢（供 UI 列表/行事曆視圖）  \n\n表（供 Supabase）  \n\nscheduled_nudges：事件/提醒主表 ○ id, user_id, title, start, end, tz, all_day, rrule, location, description, attendees[], reminders[], calendar_id, source_conv_id, status  \n\nnudges_log：發送/同步紀錄  \n\ntime_prefs：個人化時段預設（早上/傍晚對應時間）  \n\n九、範例對話 $\\longrightarrow$ 結果  \n\n用戶：明天早上提醒我去跑步。  \nAI 問：早上大約幾點？（8:00 / 9:00 / 10:00）用戶：5:30  \nAI 問：需要重複嗎？（不重複 $/$ 每天 $/$ 每週五）用戶：每週五  \nAI 問：要提醒嗎？（10 分 / 30 分 $/$ 不用）  \n用戶：10 分  \nAI 摘要：9/5(五) 05:30–06:00《跑步》，每週五  \n\n用戶：✅$\\longrightarrow$ 寫入 scheduled_nudges，輸出 ICS 事件；5–15 分內手機收到 Google Calendar 原生提醒。  \n\n對齊你截圖中的欄位：標題、日期/時間、時區、重複、提醒、類別都能被自動填上。  \n\n十、驗收清單（DoD）  \n\n對話一句內能偵測意圖並產生至少 1 個候選事件。  \n\n最多 3 次追問 完成必要槽位。  \n\n產出 確認摘要 並在使用者同意後建立事件。  \n\n事件同步到 ICS 訂閱；Google/Apple 端能在 5–15 分 內看到。  \n\n事件同時出現在 承諾清單（Mark-1） 的「待觸發」中。  \n\n十一、落地小提示  \n\n時間解析：優先用規則 $^+$ 簡單 NER；之後再接 Duckling/Chrono。  \n\n預設值：先談「可以用預設嗎 $^{\\gamma\\,_{\\perp}\\rightarrow}$ 減少追問。  \n\n中/英混用：時間、週期詞彙做雙語字典。  \n失敗退路：拿不到時間 $\\rightarrow$ 轉「待補資訊草稿」存草稿區，不直接建。  \n\n食材清單附錄（密鑰 / 環境變數 / API Key  \n\n類别變數名/Key用途説明状態SupabaseSUPABASE_URLSupabase專案URL待瓣SupabaseSUPABASE_ANON_KEY用户端存取用AnonKey待瓣SupabaseSUPABASE_SERVICE_ROLE_KEYServer用ServiceRoleKey（高權限）待瓣MinimaxMINIMAX_API_KEY呼叫Minimax模型API待辦GitHubGITHUB_TOKEN自動部署/CI用待辨RailwayRAILWAY_TOKENRailway部署/Worker啟動Token待辦VercelVERCEL_TOKENVercel部署用（CI/CD)待瓣NotionNOTION_API_KEY呼叫NotionAPI待辦NotionNOTION_DB_ID_MEMORY記憶資料库（咒語/歷史）ID待瓣NotionNOTION_DB_ID_SKILL技能資料库ID待辨  \n\nGoogleGOOGLE_CLIENT_IDOAuth登入/Calendar用待辦GoogleGOOGLE_CLIENT_SECRETOAuth Secret待瓣GoogleGOOGLE_CALLBACK_URISupabase/Backend callbackURI待辦WeChatWECHAT_APPID微信登入/通知ApplD待瓣WeChatWECHAT_SECRET微信AppSecret待辦ICS订閣ICS_BASE_URL產生行事厝feed的baseurl待瓣ICS订閣ICS_SECRET_TOKEN保護用的随機長Token待瓣WebSocketWS_ENDPOINTWebSocket服務端點（提醒即時傅送）待辨系統管理ADMIN_EMAIL總管理員帐号待辦系統管理ADMIN_PASS總管理員密碼（建改成Vault/環境變數管理）待瓣", "files_in_pdf": [{"path": ".pdf_temp/靈信_2_0開發計畫_1757048142/images/gymdm0.jpg", "size": 155079}, {"path": ".pdf_temp/靈信_2_0開發計畫_1757048142/images/gdej31.jpg", "size": 159851}, {"path": ".pdf_temp/靈信_2_0開發計畫_1757048142/images/ug0it2.jpg", "size": 98960}, {"path": ".pdf_temp/靈信_2_0開發計畫_1757048142/images/6ys445.jpg", "size": 185055}]}